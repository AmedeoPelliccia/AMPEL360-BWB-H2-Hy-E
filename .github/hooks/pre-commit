#!/bin/bash
# AMPEL360 Q100 Pre-commit Hook
# Validates strategic mission compliance and Q100 model code presence

set -e

echo "üîç AMPEL360 Q100 Pre-commit Validation"
echo "======================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0
WARNINGS=0

# Check: Validate Q100 model code in drawing filenames
echo ""
echo "üé® Checking drawing filenames for Q100 model code..."

# Get staged SVG files that look like drawings (basename must match XX-XX-XXXX pattern)
DRAWINGS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.svg$' | while read -r file; do
    if [[ $(basename "$file") =~ ^[0-9]{2}-[0-9]{2}-[0-9]{4} ]]; then
        echo "$file"
    fi
done || true)

if [ -n "$DRAWINGS" ]; then
    MISSING_Q100=()
    
    while IFS= read -r drawing; do
        BASENAME=$(basename "$drawing")
        if [[ ! "$BASENAME" =~ Q100 ]]; then
            MISSING_Q100+=("$drawing")
        fi
    done <<< "$DRAWINGS"
    
    if [ ${#MISSING_Q100[@]} -gt 0 ]; then
        echo -e "${RED}‚ùå Error: Drawings missing Q100 model code:${NC}"
        printf '   - %s\n' "${MISSING_Q100[@]}"
        echo ""
        echo "   Expected format: XX-XX-XXXX_RevX_Q100_EFF_APP_Description.svg"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}‚úÖ All drawings include Q100 model code${NC}"
    fi
else
    echo "   No drawing files to check"
fi

echo ""
echo "‚úÖ Pre-commit validation passed!"
exit 0
