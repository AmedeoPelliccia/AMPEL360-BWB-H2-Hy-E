name: GenCCC Cross-Reference Intelligence

on:
  pull_request:
    paths:
      - "**/*.md"
      - "tools/genccc/**"
      - ".github/workflows/genccc.yml"
  issue_comment:
    types: [created]

permissions:
  contents: write         # push fixes/branches
  pull-requests: write    # comment / open PRs
  actions: read
  checks: read
  statuses: write         # set commit statuses

jobs:
  # 1) Generate audit on PRs
  report:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Generate Cross-Reference Report
        run: |
          mkdir -p cd/reports
          python tools/genccc/report.py

      - name: Show generated audit
        run: |
          echo "Generated audit file:"
          ls -la cd/reports || true
          if [ -f cd/reports/cross_reference_audit.md ]; then
            sed -n '1,200p' cd/reports/cross_reference_audit.md || true
          fi

      - name: Upload Audit Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: genccc-cross-reference-audit
          path: cd/reports/cross_reference_audit.md
          retention-days: 30

      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                "üìÑ **GenCCC Cross-Reference Audit Report Generated**",
                "",
                "Download artifact:",
                "> **genccc-cross-reference-audit**",
                "",
                "To apply auto-fixes and generate contextual documents, comment:",
                "",
                "`/genccc apply`",
                "",
                "For full agent-driven resolution (child PR), comment:",
                "",
                "`/genccc solve`"
              ].join("\n")
            });

  # 1b) Validate requirements on PRs
  req-validate:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Validate Requirements
        run: |
          mkdir -p cd/reports
          python tools/genccc/validate.py || true

      - name: Generate Traceability Matrices
        run: |
          python tools/genccc/traceability.py || true

      - name: Upload Requirements Reports
        uses: actions/upload-artifact@v4
        with:
          name: genccc-requirements-reports
          path: |
            cd/reports/requirements_validation.md
            cd/reports/requirements_traceability_matrix.md
            cd/reports/verification_coverage_matrix.md
            cd/reports/Requirements_Traceability_Matrix.csv
            cd/reports/Verification_Coverage_Matrix.csv
          retention-days: 30

      - name: Check Validation Results
        id: check-validation
        run: |
          if [ -f cd/reports/requirements_validation.md ]; then
            if grep -q "‚ùå Validation failed" cd/reports/requirements_validation.md; then
              echo "validation_failed=true" >> $GITHUB_OUTPUT
            else
              echo "validation_failed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "validation_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Validation Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let validationMsg = '';
            let coverageMsg = '';
            
            try {
              const validationReport = fs.readFileSync('cd/reports/requirements_validation.md', 'utf8');
              const lines = validationReport.split('\n').slice(0, 20);
              validationMsg = lines.join('\n');
            } catch (e) {
              validationMsg = 'No requirements validation report generated.';
            }
            
            try {
              const coverageReport = fs.readFileSync('cd/reports/verification_coverage_matrix.md', 'utf8');
              const lines = coverageReport.split('\n');
              const summaryLines = lines.slice(0, 25).join('\n');
              coverageMsg = summaryLines;
            } catch (e) {
              coverageMsg = 'No coverage matrix generated.';
            }
            
            const body = [
              "üìã **Requirements Management Report**",
              "",
              "### Validation Results",
              "```",
              validationMsg,
              "```",
              "",
              "### Coverage Summary",
              "```",
              coverageMsg,
              "```",
              "",
              "Download full reports from artifact: **genccc-requirements-reports**"
            ].join("\n");
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

  # 2) Apply quick fixes on-demand: `/genccc apply`
  apply:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/genccc apply')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Check commenter permissions
        id: check-permissions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner, repo: context.repo.repo, username: context.actor
            });
            const ok = ['write','admin','maintain'].includes(permission.permission);
            if (!ok) {
              core.setFailed(`@${context.actor} lacks permission for /genccc apply`);
              await github.rest.issues.createComment({
                issue_number: context.issue.number, owner: context.repo.owner, repo: context.repo.repo,
                body: `‚ùå @${context.actor} does not have permission to run \`/genccc apply\`.`
              });
              return;
            }
            core.setOutput('has_permission','true');

      - name: Checkout base branch (trusted scripts)
        if: steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/checkout@v4
        with:
          path: base
          fetch-depth: 0

      - name: Checkout PR branch (content)
        if: steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr
          token: ${{ secrets.GENCCC_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        if: steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install OpenAI Client
        if: steps.check-permissions.outputs.has_permission == 'true'
        run: pip install openai

      - name: Copy GenCCC scripts from base to safe location
        if: steps.check-permissions.outputs.has_permission == 'true'
        run: |
          mkdir -p /tmp/genccc_scripts
          cp -r base/tools/genccc/* /tmp/genccc_scripts/

      - name: Run GenCCC Apply on PR content
        if: steps.check-permissions.outputs.has_permission == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cd pr
          python /tmp/genccc_scripts/apply.py

      - name: Commit & Push Changes
        if: steps.check-permissions.outputs.has_permission == 'true'
        id: commit_push
        run: |
          cd pr
          git config user.name "GenCCC Bot"
          git config user.email "genccc-bot@local"
          git add .
          if git commit -m "GenCCC: Apply auto-linking and contextual document generation"; then
            echo "changes_committed=true" >> $GITHUB_OUTPUT
            git push
          else
            echo "changes_committed=false" >> $GITHUB_OUTPUT
          fi

      - name: Post result comment
        if: steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const committed = `${{ steps.commit_push.outputs.changes_committed }}` === 'true';
            const body = committed
              ? '‚úÖ **GenCCC Apply completed!**\n\nAutomatic fixes have been applied and committed to this PR.\n\nPlease review the changes before merging.'
              : '‚ÑπÔ∏è **GenCCC Apply completed.**\n\nNo changes were necessary, so nothing was committed.';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

  # 3) Agent flow: automatic on PRs + on-demand `/genccc solve`
  agent_child_pr:
    if: >
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/genccc solve'))
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Resolve PR context
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNum = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prNum
            });
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('from_fork', String(!!pr.head.repo.fork));

      - name: Checkout base (trusted)
        uses: actions/checkout@v4
        with:
          path: base
          fetch-depth: 0

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          path: pr
          token: ${{ secrets.GENCCC_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download latest audit artifact (if present)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: genccc-cross-reference-audit
          path: pr/cd/reports

      - name: Generate fresh audit for comment-trigger
        if: github.event_name == 'issue_comment'
        run: |
          cd pr
          mkdir -p cd/reports
          if [ -f tools/genccc/report.py ]; then
            python tools/genccc/report.py
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install OpenAI Client
        run: pip install openai

      - name: Copy GenCCC scripts from base to safe location
        run: |
          mkdir -p /tmp/genccc_scripts
          cp -r base/tools/genccc/* /tmp/genccc_scripts/

      - name: Run GenCCC Agent (goal-seeking)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_NUMBER: ${{ github.event.issue.number || github.event.number }}
          PR_HEAD_REF: ${{ steps.pr.outputs.head_ref }}
          PR_BASE_REF: ${{ steps.pr.outputs.base_ref }}
        run: |
          set -e
          REPORT_PATH="pr/cd/reports/cross_reference_audit.md"
          [ -f "$REPORT_PATH" ] || echo "::warning::Audit report not found. Proceeding without it."
          python /tmp/genccc_scripts/agent.py \
            --repo-root ./pr \
            --pr-number "${PR_NUMBER}" \
            --base-branch "${PR_BASE_REF}" \
            --head-branch "${PR_HEAD_REF}" \
            --report-path "$REPORT_PATH" \
            --goal "Come to a certifiable, standards-compliant solution by fixing cross-references, adding missing context docs, and wiring version/traceability links so that GenCCC report passes with[...]"

      - name: Detect agent changes
        id: diff
        run: |
          cd pr
          git init -q
          git config user.name "GenCCC Agent Bot"
          git config user.email "genccc-agent-bot@local"
          git add -A
          # determine if there are staged changes (added above)
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create child branch & push (same-repo PRs)
        if: steps.diff.outputs.changed == 'true' && steps.pr.outputs.from_fork == 'false'
        id: push_same
        run: |
          set -e
          cd pr
          CHILD_BRANCH="genccc/agent-${{ steps.pr.outputs.head_ref }}-$(date +%Y%m%d%H%M%S)"
          git commit -m "GenCCC Agent: proposed fixes to reach solution"
          git branch -M "$CHILD_BRANCH"
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git push -u origin "$CHILD_BRANCH"
          echo "child_branch=$CHILD_BRANCH" >> $GITHUB_OUTPUT

      - name: Open child PR into original PR branch (same-repo)
        if: steps.push_same.outputs.child_branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = "GenCCC Agent: Child PR to reach solution";
            const body  = [
              "This child PR was opened by **GenCCC Agent**.",
              "",
              "Goal: *Come to a certifiable, standards-compliant solution that satisfies the GenCCC cross-reference audit.*",
              "",
              "- Applies auto-fixes and generates missing context docs",
              "- Wires versioning/traceability according to ATA/OPT-IN",
              "- Targets the original PR branch for review & merge/cherry-pick",
            ].join("\n");
            const prNum = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prNum
            });
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: "${{ steps.push_same.outputs.child_branch }}",
              base: pr.head.ref,
              draft: true
            });

      - name: Fallback push (fork PRs) ‚Äì proposal into base
        if: steps.diff.outputs.changed == 'true' && steps.pr.outputs.from_fork == 'true'
        id: push_fork
        run: |
          set -e
          cd pr
          CHILD_BRANCH="genccc/agent-proposal-$(date +%Y%m%d%H%M%S)"
          git commit -m "GenCCC Agent: proposal fixes (fork-safe)"
          git branch -M "$CHILD_BRANCH"
          git remote add origin "https://x-access-token:${{ secrets.GENCCC_PAT || secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git push -u origin "$CHILD_BRANCH"
          echo "child_branch=$CHILD_BRANCH" >> $GITHUB_OUTPUT

      - name: Open proposal PR into base (fork-safe)
        if: steps.push_fork.outputs.child_branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GENCCC_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const title = "GenCCC Agent: Proposal (fork-safe) to reach solution";
            const body  = [
              "Contributor PR comes from a **fork**; bots cannot push to contributor's fork.",
              "This draft PR targets the **base branch** with proposed fixes.",
              "",
              "Goal: *Come to a certifiable, standards-compliant solution that satisfies the GenCCC cross-reference audit.*",
              "",
              "Maintainers can merge this PR or cherry-pick into the contributor PR.",
            ].join("\n");
            const prNum = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prNum
            });
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: "${{ steps.push_fork.outputs.child_branch }}",
              base: pr.base.ref,
              draft: true
            });

      - name: Comment link in original PR
        if: steps.diff.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const msg = [
              "ü§ñ **GenCCC Agent prepared a proposal.**",
              "If same-repo, a **child PR** into the contributor branch was opened.",
              "If fork, a **draft proposal PR** into the base branch was opened.",
              "",
              "Review & merge/cherry-pick as needed."
            ].join("\n");
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: msg
            });

      - name: No changes to propose
        if: steps.diff.outputs.changed != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner, repo: context.repo.repo,
              body: "‚ÑπÔ∏è GenCCC Agent found no actionable changes to propose."
            });

  # 4) Verify child branch by re-running the GenCCC audit
  verify_child_proposal:
    name: Verify Child Proposal (re-run GenCCC audit)
    needs: [agent_child_pr]
    if: needs.agent_child_pr.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: main-repo

      - name: Resolve child branch (same-repo vs fork-safe)
        id: childref
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: branches } = await github.rest.repos.listBranches({
              owner: context.repo.owner, repo: context.repo.repo, protected: false, per_page: 100
            });
            const cand = branches.find(b => b.name.startsWith('genccc/agent-'));
            if (!cand) { core.setOutput('found','false'); }
            else { core.setOutput('found','true'); core.setOutput('ref', cand.name); }

      - name: Exit if no child branch found
        if: steps.childref.outputs.found != 'true'
        run: echo "No child branch found. Skipping verification."

      - name: Checkout child branch (isolated path)
        if: steps.childref.outputs.found == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.childref.outputs.ref }}
          path: child-repo
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Python
        if: steps.childref.outputs.found == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Run GenCCC audit on child
        if: steps.childref.outputs.found == 'true'
        working-directory: main-repo
        env:
          GENCCC_TARGET_ROOT: ${{ github.workspace }}/child-repo
        run: |
          python tools/genccc/report.py

      - name: Upload Child Audit Artifact
        if: steps.childref.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: genccc-cross-reference-audit-child
          path: child-repo/cd/reports/cross_reference_audit.md
          retention-days: 14

      - name: Comment audit status in original PR
        if: steps.childref.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const msg = [
              "üß™ **GenCCC verification run on child branch completed.**",
              "",
              "Artifact: **genccc-cross-reference-audit-child**",
              "Please review results; if clean, merge the child PR or cherry-pick into the original PR."
            ].join("\n");
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: msg
            });

  # 4b) Create requirements baseline on-demand: `/genccc baseline`
  baseline:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/genccc baseline')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Create Baseline
        id: create-baseline
        run: |
          python tools/genccc/baseline.py create --name "PR-${{ github.event.issue.number }}" || echo "No requirements found"
          if ls cd/baselines/requirements_PR-*.json 1> /dev/null 2>&1; then
            echo "baseline_created=true" >> $GITHUB_OUTPUT
          else
            echo "baseline_created=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Baseline Diff
        if: steps.create-baseline.outputs.baseline_created == 'true'
        run: |
          python tools/genccc/baseline.py diff || echo "Baseline diff not available"

      - name: Upload Baseline Artifacts
        if: steps.create-baseline.outputs.baseline_created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: genccc-baseline-${{ github.event.issue.number }}
          path: |
            cd/baselines/requirements_PR-*.json
            cd/reports/baseline_diff.md
          retention-days: 90

      - name: Post Baseline Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let diffMsg = '';
            
            try {
              const diffReport = fs.readFileSync('cd/reports/baseline_diff.md', 'utf8');
              const lines = diffReport.split('\n').slice(0, 30);
              diffMsg = lines.join('\n');
            } catch (e) {
              diffMsg = 'No baseline diff available (this may be the first baseline).';
            }
            
            const body = [
              "üì¶ **Requirements Baseline Created**",
              "",
              "A snapshot of current requirements has been saved.",
              "",
              "### Baseline Diff Preview",
              "```",
              diffMsg,
              "```",
              "",
              `Download full baseline from artifact: **genccc-baseline-${{ github.event.issue.number }}**`,
              "",
              "Use baselines to track requirements changes over time and perform impact analysis."
            ].join("\n");
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

  # 5) Enforce completion targets and set a status on PR head commit
  completion_check:
    name: Enforce Completion Targets (Audit Compliance & Actions)
    needs: [verify_child_proposal]
    if: always() && needs.verify_child_proposal.result != 'skipped'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout Base for V&V Lake Access
        uses: actions/checkout@v4
        with:
          path: base
          fetch-depth: 1

      - name: Download Child Audit Artifact (if present)
        id: dl-audit
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: genccc-cross-reference-audit-child
          path: reports

      - name: Collect PR context (head sha & changed files)
        id: prctx
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNum = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prNum
            });
            const headSha = pr.head.sha;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prNum, per_page: 100
            });
            const mdChanged = files.map(f => f.filename).filter(n => n.endsWith('.md')).join(', ');
            core.setOutput('head_sha', headSha);
            core.setOutput('md_changed', mdChanged);

      - name: Pool Verification Points from Artifacts
        id: pool
        run: |
          AUDIT_FILE="reports/cross_reference_audit.md"
          VV_LAKE="base/cd/vv_lake.json"
          
          # Handle audit file with proper output redirection
          if [ ! -f "$AUDIT_FILE" ]; then
            echo "::warning::Audit file not found at $AUDIT_FILE. Counting issues as 0."
            echo "pooled_issues=0" >> $GITHUB_OUTPUT
          else
            COUNT=$(grep -Ei "warning|error|issue" "$AUDIT_FILE" | wc -l || echo 0)
            echo "pooled_issues=$COUNT" >> $GITHUB_OUTPUT
          fi
          
          # Fail if V&V Lake is missing to ensure compliance integrity
          if [ ! -f "$VV_LAKE" ]; then
            echo "::error::Critical configuration 'vv_lake.json' missing. Cannot verify compliance."
            exit 1
          fi

          STANDARDS=$(jq -r '.standards[]?' "$VV_LAKE" | paste -sd, -)
          PATHS=$(jq -r '.paths[]?' "$VV_LAKE" | paste -sd, -)
          
          echo "standards=$STANDARDS" >> $GITHUB_OUTPUT
          echo "validation_paths=$PATHS" >> $GITHUB_OUTPUT

      - name: Build Contextual Checklists from V&V Lake
        id: checklist
        run: |
          STANDARDS="${{ steps.pool.outputs.standards }}"
          VALIDATION_PATHS="${{ steps.pool.outputs.validation_paths }}"
          CHANGED="${{ steps.prctx.outputs.md_changed }}"
          VV_LAKE="base/cd/vv_lake.json"

          CHECKLIST="- [ ] Cross-references validated against: ${VALIDATION_PATHS:-n/a}
- [ ] Standards compliance (${STANDARDS:-n/a})
- [ ] Traceability links complete"
          if [ -n "$CHANGED" ]; then
            CHECKLIST="$CHECKLIST
- [ ] Contextual validation for changed files: $CHANGED"
          fi
          if [ -f "$VV_LAKE" ]; then
            EXTRA=$(jq -r '.checklists.contextual[]?' "$VV_LAKE" 2>/dev/null | sed 's/^/- [ ] /' || true)
            if [ -n "$EXTRA" ]; then
              CHECKLIST="$CHECKLIST
$EXTRA"
            fi
          fi

          # Properly emit multiline output to $GITHUB_OUTPUT (do not quote EOF)
          echo "checklist<<EOF" >> "$GITHUB_OUTPUT"
          printf "%s\n" "$CHECKLIST" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Validate Against All Eventual Contextual Paths
        id: validate
        run: |
          ISSUES="${{ steps.pool.outputs.pooled_issues }}"
          PATHS="${{ steps.pool.outputs.validation_paths }}"
          CHECKLIST="${{ steps.checklist.outputs.checklist }}"
          VALID=true
          if [ "${ISSUES:-0}" -gt 0 ]; then
            VALID=false
            echo "::error::Validation failed: ${ISSUES} unresolved audit issues."
          fi
          if [ -z "$PATHS" ]; then
            VALID=false
            echo "::warning::No validation paths defined in V&V lake."
          fi
          if [ "$VALID" = true ]; then
            UPDATED_CHECKLIST="$(printf "%s\n" "$CHECKLIST" | sed 's/- \[ \]/- [x]/g')"
          else
            UPDATED_CHECKLIST="$CHECKLIST"
          fi
          echo "validation_passed=$VALID" >> $GITHUB_OUTPUT

          # Properly emit multiline updated_checklist
          echo "updated_checklist<<EOF" >> "$GITHUB_OUTPUT"
          printf "%s\n" "$UPDATED_CHECKLIST" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Set PR Status Check (on PR head SHA)
        uses: actions/github-script@v7
        env:
          VALIDATION_PASSED: ${{ steps.validate.outputs.validation_passed }}
          POOLED_ISSUES: ${{ steps.pool.outputs.pooled_issues }}
          PR_HEAD_SHA: ${{ steps.prctx.outputs.head_sha }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const passed = (process.env.VALIDATION_PASSED === 'true');
            const issues = process.env.POOLED_ISSUES || '0';
            const sha = process.env.PR_HEAD_SHA;
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha,
              state: passed ? 'success' : 'failure',
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: passed ? 'Completion targets met - all paths validated'
                                  : `Targets incomplete - ${issues} issues; see checklist`,
              context: 'GenCCC Completion Target'
            });

      - name: Post Contextual Checklist in PR
        uses: actions/github-script@v7
        env:
          UPDATED_CHECKLIST: ${{ steps.validate.outputs.updated_checklist }}
          VALIDATION_PASSED: ${{ steps.validate.outputs.validation_passed }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = (process.env.VALIDATION_PASSED === 'true')
              ? `üéØ **Completion Targets Achieved!**\n\nContextual checklist (auto-validated):\n\n${process.env.UPDATED_CHECKLIST}\n\nAll validation paths covered. Ready for merge.`
              : `‚ö†Ô∏è **Completion Targets Incomplete**\n\nContextual checklist (review required):\n\n${process.env.UPDATED_CHECKLIST}\n\nAddress issues to meet standards and paths.`;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Fail Workflow on Incomplete Targets
        if: steps.validate.outputs.validation_passed != 'true'
        run: |
          echo "::error::Completion targets not met. Review pooled points and checklist."
          exit 1
