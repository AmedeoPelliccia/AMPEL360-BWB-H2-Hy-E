# CGen - Continuous Generation
#
# This workflow runs AI/automation to generate and update documentation,
# diagrams, indexes, and traceability artifacts. All changes are proposed
# via bot PRs for human review - never silent commits.
#
# CGen Lane Responsibilities:
# - Generate/update documentation, diagrams, indexes
# - Build traceability artifacts (GenCCC reports, cross-ref maps)
# - Propose new assets (placeholder docs, skeletons) as PRs
# - Rebuild indexes and dashboards on schedule
#
# Principle: CGen PROPOSES via bot PRs, humans approve

name: CGen - Continuous Generation

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * *'   # Nightly at 3 AM UTC
  workflow_dispatch:
    inputs:
      mode:
        description: 'Generation mode'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - docs-only
          - indexes-only

permissions:
  contents: write        # Needed for automation PRs
  pull-requests: write

jobs:
  cgen:
    name: Continuous Generation
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # Install any CGen-specific dependencies
          pip install openai 2>/dev/null || echo "OpenAI not needed for basic generation"

      - name: Configure Git
        run: |
          git config user.name "ampel360-cgen-bot"
          git config user.email "ampel360-cgen-bot@users.noreply.github.com"

      - name: Generate summary tables
        run: |
          echo "=== Generating Summary Tables ==="
          mkdir -p cd/reports
          if [ -f tools/generate_summary_tables.py ]; then
            python tools/generate_summary_tables.py || echo "Summary table generation completed with warnings"
          else
            echo "generate_summary_tables.py not found - skipping"
          fi

      - name: Run GenCCC baseline report
        run: |
          echo "=== Generating GenCCC Baseline Report ==="
          mkdir -p cd/reports
          if [ -f tools/genccc/report.py ]; then
            python tools/genccc/report.py || echo "GenCCC baseline report completed with warnings"
          else
            echo "GenCCC report.py not found - skipping"
          fi

      - name: Generate traceability matrices
        run: |
          echo "=== Generating Traceability Matrices ==="
          if [ -f tools/genccc/traceability.py ]; then
            python tools/genccc/traceability.py || echo "Traceability generation completed with warnings"
          else
            echo "traceability.py not found - skipping"
          fi

      - name: Update document indexes (CGen Lane 1)
        run: |
          echo "=== Updating Document Indexes (CGen Lane 1) ==="
          # Auto-generate 00_INDEX.md files throughout the repository
          if [ -f tools/ci/auto_index_generator.py ]; then
            python tools/ci/auto_index_generator.py --root OPT-IN_FRAMEWORK --write || echo "Index generation completed with warnings"
          else
            echo "auto_index_generator.py not found - skipping"
          fi

      - name: Generate requirement skeletons (if needed)
        run: |
          echo "=== Generating Missing Requirement Skeletons ==="
          if [ -f tools/genccc/generate.py ]; then
            python tools/genccc/generate.py || echo "Skeleton generation completed"
          else
            echo "generate.py not found - skipping"
          fi

      - name: Check for changes
        id: check_changes
        run: |
          git status --short
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Create CGen branch
        if: steps.check_changes.outputs.has_changes == 'true'
        id: create_branch
        run: |
          BRANCH="cgen/update-$(date +%Y%m%d-%H%M%S)"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH"

      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "CGen: automated documentation & reports update

          Generated by Continuous Generation pipeline:
          - Summary tables updated
          - GenCCC baseline report
          - Traceability matrices
          - Document indexes refreshed
          
          AI assistance: GitHub Copilot, prompted by Amedeo Pelliccia
          Status: DRAFT - Subject to human review and approval"

      - name: Push CGen branch
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push origin "${{ steps.create_branch.outputs.branch }}"

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.create_branch.outputs.branch }}
          title: "CGen: Automated documentation & reports update"
          body: |
            ## CGen Automated Update
            
            This PR contains automated updates from the Continuous Generation pipeline.
            
            ### Changes Include:
            - ðŸ“Š Summary tables updated
            - ðŸ”— GenCCC baseline report
            - ðŸ“‹ Traceability matrices
            - ðŸ“‘ Document indexes refreshed
            - ðŸ”„ Cross-reference updates
            
            ### Review Instructions:
            1. Review the generated content for accuracy
            2. Verify cross-references are correct
            3. Check that AI-generated content has proper Document Control sections
            4. Approve and merge if all looks good
            
            ### Document Control
            - Generated with the assistance of AI (GitHub Copilot), prompted by **Amedeo Pelliccia**
            - Status: **DRAFT** â€“ Subject to human review and approval
            - Repository: `AMPEL360-BWB-H2-Hy-E`
            - Last AI update: ${{ github.event.head_commit.timestamp }}
            
            ---
            **CGen Principle**: Propose changes via PR, never silent commits
          labels: |
            cgen
            documentation
            automated
          draft: false

      - name: Upload CGen reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cgen-reports-${{ github.run_number }}
          path: cd/reports/
          retention-days: 30

      - name: CGen Summary
        if: always()
        run: |
          echo "# CGen Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Generation Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… Changes detected and committed to branch: \`${{ steps.create_branch.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes needed - all artifacts are up to date" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Generated Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Summary tables" >> $GITHUB_STEP_SUMMARY
          echo "- GenCCC baseline report" >> $GITHUB_STEP_SUMMARY
          echo "- Traceability matrices" >> $GITHUB_STEP_SUMMARY
          echo "- Document indexes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CGen Principle**: Propose via bot PRs, humans approve" >> $GITHUB_STEP_SUMMARY
