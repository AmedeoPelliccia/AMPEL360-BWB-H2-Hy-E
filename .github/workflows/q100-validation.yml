name: Q100 Validation Suite

on:
  pull_request:
    paths:
      - 'OPT-IN_FRAMEWORK/**'
      - 'tools/validators/**'
      - '.github/workflows/q100-validation.yml'
  push:
    branches: [main]
    paths:
      - 'OPT-IN_FRAMEWORK/**'
      - 'tools/validators/**'
      - '.github/workflows/q100-validation.yml'
  workflow_dispatch:

jobs:
  validate-structure:
    name: Validate Directory Structure
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate OPT-IN Framework structure
        id: structure_check
        continue-on-error: true
        run: |
          python tools/validators/structure_validator.py . | tee structure_validation.txt

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: structure-validation-report
          path: structure_validation.txt
          retention-days: 30

      - name: Add job summary
        if: always()
        run: |
          echo "## üìÅ Directory Structure Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f structure_validation.txt ]; then
            cat structure_validation.txt >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if validation errors found
        if: steps.structure_check.outcome == 'failure'
        run: |
          echo "::error title=Directory Structure Issues::Review the validation report for details."
          exit 1

  validate-file-formats:
    name: Validate File Formats
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for forbidden file extensions
        id: format_check
        run: |
          echo "Checking for forbidden file extensions (.pdf, .xlsx, .docx, .pptx)..."
          
          FORBIDDEN_FILES=$(find OPT-IN_FRAMEWORK -type f \( \
            -name "*.pdf" -o \
            -name "*.xlsx" -o \
            -name "*.xls" -o \
            -name "*.docx" -o \
            -name "*.doc" -o \
            -name "*.pptx" \
          \) 2>/dev/null || true)
          
          if [ -n "$FORBIDDEN_FILES" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "$FORBIDDEN_FILES" > forbidden_files.txt
            echo "::error title=Forbidden File Formats::Found files with forbidden extensions"
            echo "Found files with forbidden extensions:"
            echo "$FORBIDDEN_FILES"
            exit 1
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No forbidden file extensions found"
          fi

      - name: Upload forbidden files list
        if: steps.format_check.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: forbidden-files-list
          path: forbidden_files.txt
          retention-days: 30

  validate-strategic-mission:
    name: Validate Strategic Mission References
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Q100 model code in new files
        run: |
          echo "Checking for Q100 model code in relevant files..."
          
          # Check drawing files
          DRAWINGS=$(find OPT-IN_FRAMEWORK -type f -name "*.svg" | grep -E "^[0-9]{2}-[0-9]{2}-[0-9]{4}" || true)
          
          MISSING_Q100=()
          for drawing in $DRAWINGS; do
            if [[ ! $(basename "$drawing") =~ Q100 ]]; then
              MISSING_Q100+=("$drawing")
            fi
          done
          
          if [ ${#MISSING_Q100[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: Found drawings without Q100 model code:"
            printf '%s\n' "${MISSING_Q100[@]}"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚ö†Ô∏è  Q100 Model Code Missing" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following drawings are missing the Q100 model code:" >> $GITHUB_STEP_SUMMARY
            printf '- %s\n' "${MISSING_Q100[@]}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All drawings include Q100 model code"
          fi

  security-scan:
    name: Security Scan for Safety-Critical Code
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] safety

      - name: Run Bandit security scan
        continue-on-error: true
        run: |
          echo "Running Bandit security scan on Python code..."
          bandit -r tools/ -f json -o bandit-report.json || true
          bandit -r tools/ -f screen

      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 90

      - name: Check for safety-critical code compliance
        run: |
          echo "Checking for DO-178C compliance tags in safety-critical code..."
          
          # Search for SAFETY-CRITICAL comments without DO-178C tags
          CRITICAL_FILES=$(grep -r "SAFETY-CRITICAL" tools/ --include="*.py" -l || true)
          
          if [ -n "$CRITICAL_FILES" ]; then
            echo "Found safety-critical code files:"
            echo "$CRITICAL_FILES"
            
            for file in $CRITICAL_FILES; do
              if ! grep -q "DO-178C" "$file"; then
                echo "‚ö†Ô∏è  Warning: $file missing DO-178C compliance tag"
              fi
            done
          fi
