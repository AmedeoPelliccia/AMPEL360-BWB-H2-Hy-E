name: Geometry Baseline Watchdog

on:
  pull_request:
    paths:
      - "OPT-IN_FRAMEWORK/I-INFRASTRUCTURES/ATA_02-OPERATIONS_INFORMATION/02-11-00_AIRCRAFT_DIMENSIONS_GEOMETRY/**"
      - ".github/workflows/geometry-baseline-watchdog.yml"
      - "tools/ci/check_dimensions.py"
  push:
    branches:
      - main
    paths:
      - "OPT-IN_FRAMEWORK/I-INFRASTRUCTURES/ATA_02-OPERATIONS_INFORMATION/02-11-00_AIRCRAFT_DIMENSIONS_GEOMETRY/**"
      - ".github/workflows/geometry-baseline-watchdog.yml"
      - "tools/ci/check_dimensions.py"

jobs:
  geometry-watchdog:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (none for now)
        run: |
          python -m pip install --upgrade pip

      - name: Run geometry baseline check
        id: check_geom
        continue-on-error: true   # allow next step to inspect result
        run: |
          python tools/check_dimensions.py

      - name: Fail PR if deviations found
        if: steps.check_geom.outcome == 'failure'
        run: |
          echo "::error title=Geometry baseline changed::See geometry_deviations_report.md for details."
          exit 1

      - name: Open / update ECR issue on deviation
        if: steps.check_geom.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = "geometry_deviations_report.md";
            let body = "";
            if (fs.existsSync(path)) {
              body = fs.readFileSync(path, "utf8");
            } else {
              body = "Geometry baseline deviation detected, but no report file was found.";
            }

            const repo = context.repo;

            // Look for an open ECR issue for this component
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: repo.owner,
              repo: repo.repo,
              labels: "ECR,02-11-00",
              state: "open"
            });

            if (issues.length > 0) {
              const issue = issues[0];
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: issue.number,
                body: "New geometry deviation detected:\n\n" + body
              });
              core.info(`Updated existing ECR issue #${issue.number}`);
            } else {
              const { data: newIssue } = await github.rest.issues.create({
                owner: repo.owner,
                repo: repo.repo,
                title: "ECR â€“ Geometry Baseline Change Detected (02-11-00)",
                body: body,
                labels: ["ECR", "02-11-00", "geometry-change"]
              });
              core.info(`Created new ECR issue #${newIssue.number}`);
            }
